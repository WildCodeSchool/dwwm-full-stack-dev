name: Bdd MYSQL Quest 6

on:
    push:
        paths:
          - "src/Bdd/Mysql/Quest-6/**"
    pull_request:
        types: [opened, synchronize, reopened, ready_for_review]
        paths:
          - "src/Bdd/Mysql/Quest-6/**"

jobs:
    check-files:
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v2

            -   id: files
                uses: jitterbit/get-changed-files@v1

            -   name: Printing
                run: |
                    echo "All:"
                    echo "${{ steps.abc.outputs.all }}"
                    echo "Added:"
                    echo "${{ steps.abc.outputs.added }}"
                    echo "Removed:"
                    echo "${{ steps.abc.outputs.removed }}"
                    echo "Renamed:"
                    echo "${{ steps.abc.outputs.renamed }}"
                    echo "Modified:"
                    echo "${{ steps.abc.outputs.modified }}"
                    echo "Added+Modified:"
                    echo "${{ steps.abc.outputs.added_modified }}"

    validation:
        runs-on: ubuntu-latest

        env:
            resource-dump: ./resources/Bdd/Mysql/dump_quete_519_finie.sql
            working-directory: ./src/Bdd/Mysql/Quest-6
            db_name: wild_db_quest
            db_password: db_password
        services:
            mysql:
                image: mysql:8.0.27
                env:
                    MYSQL_DATABASE: ${{ env.db_name }}
                    MYSQL_ROOT_PASSWORD: ${{ env.db_password }}
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=3
        steps:
            -   name: Checkout
                uses: actions/checkout@v2

            -   name: Recherche des fichiers non autorisés dans la PR
                if: github.event_name == 'pull_request'
                id: diff
                run: |
                    echo "${{ github.event.before }}"
                    echo "${{ github.event.after }}"
                    echo $GITHUB_SHA
                    echo "${{ github.event.pull_request.base.sha }}"
                    echo "::set-output name=diff::$(git --no-pager diff --name-only HEAD $(git merge-base HEAD ${{ github.event.pull_request.base.sha }}))"

            -   name: Affichage des fichiers modifiés
                if: github.event_name == 'pull_request'
                run: |
                    echo "Les fichiers modifiés sont :"
                    echo "${{ steps.diff.outputs.diff }}"

            -   name: Vérification des fichiers
                if: github.event_name == 'pull_request'
                run: |
                    if [[ $(git diff --name-only HEAD $(git merge-base HEAD ${{ github.event.pull_request.base.sha }})) =~ ^(?!src/bdd/mysql/Quest-6/quest-6.sql).* ]]; then
                        echo "Erreur : des fichiers autres que 'src/bdd/mysql/Quest-6/quest-6.sql' ont été ajoutés ou modifiés dans la pull request."
                        exit 1
                    fi

            -   name: Prepare db
                run: mysql --host=127.0.0.1 --user=root --password=${{ env.db_password }} ${{ env.db_name }} < ${{ env.resource-dump }}

            -   name: Generate Correction
                run: mysql --host=127.0.0.1 --user=root --password=${{ env.db_password }} -e "${{ secrets.BDD_MYSQL_QUEST_6_RESULT }}" ${{ env.db_name }} > correction.txt

            -   name: Generate Answer
                run: mysql --host=127.0.0.1 --user=root --password=${{ env.db_password }} ${{ env.db_name }} < ${{ env.working-directory }}/quest-6.sql > answer.txt

            -   name: Validate Answer
                run: diff correction.txt answer.txt
